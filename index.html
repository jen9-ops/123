<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Синхронизированная карта v2</title>

    <!-- Подключаем CSS Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Ваши сохраненные стили -->
    <link rel="stylesheet" href="https://jen9-ops.github.io/library/style.css">

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        #map {
            flex-grow: 1; /* Карта занимает все доступное пространство */
            width: 100%;
            background-color: #f0f0f0; /* Цвет фона на время загрузки */
        }
        #info-panel {
            background-color: #ffffff;
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-shrink: 0;
        }
        #info-panel p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #333;
        }
        #share-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        #share-url {
            flex-grow: 1;
            max-width: 350px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            background-color: #f9f9f9;
        }
        #status {
            font-size: 12px;
            font-weight: bold;
            color: #e67e22; /* Оранжевый - ожидание */
        }
        #status.connected {
            color: #2ecc71; /* Зеленый - подключено */
        }
    </style>
</head>
<body>

    <div id="info-panel">
        <p>Отправьте эту ссылку другим для синхронизации карты в реальном времени:</p>
        <div id="share-container">
            <input type="text" id="share-url" readonly onclick="this.select()">
            <span id="status">Подключение...</span>
        </div>
    </div>
    
    <div id="map"></div>

    <!-- Подключаем JS Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Ваши сохраненные скрипты -->
    <script src="https://jen9-ops.github.io/library/script.js"></script>

    <!-- Основной скрипт с логикой -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        async function runApp() {
            // --- 1. НАСТРОЙКА ---
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const statusEl = document.getElementById('status');
            
            // --- 2. АУТЕНТИФИКАЦИЯ ---
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                statusEl.textContent = "Ошибка аутентификации!";
                return; // Этот return теперь находится внутри функции и является легальным
            }
            
            // --- 3. УПРАВЛЕНИЕ СЕССИЕЙ ---
            const getSessionId = () => {
                if (window.location.hash && window.location.hash.length > 1) {
                    return window.location.hash.substring(1);
                }
                const newId = Math.random().toString(36).substring(2, 10);
                window.location.hash = newId;
                return newId;
            };
            
            const sessionId = getSessionId();
            document.getElementById('share-url').value = window.location.href;
            const docRef = doc(db, `/artifacts/${appId}/public/data/map_sessions_v2`, sessionId);

            // --- 4. ИНИЦИАЛИЗАЦИЯ КАРТЫ ---
            const map = L.map('map', { zoomControl: true }).setView([50.45, 30.52], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let isUpdatingFromFirestore = false;
            let debounceTimeout;

            // --- 5. ПОЛУЧЕНИЕ ОБНОВЛЕНИЙ ИЗ FIRESTORE ---
            onSnapshot(docRef, (doc) => {
                if (!statusEl.classList.contains('connected')) {
                    statusEl.textContent = "Подключено!";
                    statusEl.classList.add('connected');
                }

                if (doc.exists()) {
                    const data = doc.data();
                    const currentCenter = map.getCenter();
                    const currentZoom = map.getZoom();

                    // Обновляем карту, только если данные действительно отличаются
                    if (data.zoom !== currentZoom || Math.abs(data.lat - currentCenter.lat) > 0.0001 || Math.abs(data.lng - currentCenter.lng) > 0.0001) {
                        isUpdatingFromFirestore = true;
                        map.flyTo([data.lat, data.lng], data.zoom);
                        
                        map.once('moveend zoomend', () => {
                            setTimeout(() => { isUpdatingFromFirestore = false; }, 100);
                        });
                    }
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                statusEl.textContent = "Ошибка соединения!";
                statusEl.classList.remove('connected');
            });

            // --- 6. ОТПРАВКА ОБНОВЛЕНИЙ В FIRESTORE (С ОПТИМИЗАЦИЕЙ) ---
            const updateFirestore = () => {
                if (isUpdatingFromFirestore) return;

                const center = map.getCenter();
                const zoom = map.getZoom();
                
                setDoc(docRef, {
                    lat: center.lat,
                    lng: center.lng,
                    zoom: zoom
                }, { merge: true });
            };
            
            const debouncedUpdate = () => {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(updateFirestore, 250); // Ждем 250 мс после последнего движения
            };

            map.on('moveend', debouncedUpdate);
            map.on('zoomend', debouncedUpdate);
        }

        runApp();

    </script>
</body>
</html>

